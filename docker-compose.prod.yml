version: '3.8'

# ================================
# Production Environment
# Docker Compose Configuration
# ================================
# Usage: docker-compose -f docker-compose.prod.yml up -d
# Features:
# - Optimized builds
# - Resource limits
# - Health checks
# - Auto-restart policies
# - Security hardening

services:
  # ================================
  # Frontend - Next.js
  # ================================
  frontend:
    build:
      context: ./src
      dockerfile: Dockerfile.prod
      args:
        - NODE_ENV=production
    container_name: msa-frontend-prod
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_AI_API_URL=${NEXT_PUBLIC_AI_API_URL}
    networks:
      - msa-network
    depends_on:
      spring-api:
        condition: service_healthy
      python-ai:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ================================
  # Backend - Spring Boot API
  # ================================
  spring-api:
    build:
      context: ./backend/spring-ai-api
      dockerfile: Dockerfile.prod
      args:
        - SPRING_PROFILE=prod
    container_name: msa-spring-api-prod
    ports:
      - "${SPRING_PORT:-8080}:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useSSL=true&requireSSL=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=${DB_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${DB_PASSWORD}
      - SPRING_JPA_HIBERNATE_DDL_AUTO=validate
      - SPRING_JPA_SHOW_SQL=false
      - LOGGING_LEVEL_ROOT=WARN
      - LOGGING_LEVEL_APP=INFO
      - JWT_SECRET=${JWT_SECRET}
      - SERVER_TOMCAT_MAX_THREADS=${MAX_CONNECTIONS:-100}
      - SERVER_TOMCAT_CONNECTION_TIMEOUT=${CONNECTION_TIMEOUT:-30000}
    networks:
      - msa-network
    depends_on:
      mysql:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ================================
  # Backend - Python AI Server (FastAPI)
  # ================================
  python-ai:
    build:
      context: ./backend/python-ai-server
      dockerfile: Dockerfile.prod
    container_name: msa-python-ai-prod
    ports:
      - "${PYTHON_AI_PORT:-8000}:8000"
    volumes:
      # Only mount models directory (read-only)
      - ./backend/python-ai-server/models:/app/models:ro
    environment:
      - FASTAPI_ENV=production
      - YOLO_MODEL_PATH=${YOLO_MODEL_PATH}
      - WHISPER_MODEL_PATH=${WHISPER_MODEL_PATH}
      - OCR_MODEL_PATH=${OCR_MODEL_PATH}
      - MAX_IMAGE_SIZE=${MAX_IMAGE_SIZE}
      - MAX_AUDIO_LENGTH=${MAX_AUDIO_LENGTH}
      - ENABLE_GPU=${ENABLE_GPU:-false}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - WORKERS=4
    command: gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000 --timeout 120
    networks:
      - msa-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # ================================
  # Database - MySQL
  # ================================
  mysql:
    image: mysql:8.0
    container_name: msa-mysql-prod
    # DO NOT expose port in production for security
    # Only accessible within Docker network
    # ports:
    #   - "${MYSQL_PORT:-3306}:3306"
    volumes:
      # Persistent data with backup
      - mysql-data-prod:/var/lib/mysql
      # Initialization scripts
      - ./backend/spring-ai-api/src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
      # MySQL configuration
      - ./config/mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - TZ=${TZ:-Asia/Seoul}
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=caching_sha2_password
      - --max-connections=${MAX_CONNECTIONS:-100}
      - --max-allowed-packet=256M
      - --innodb-buffer-pool-size=1G
      - --slow-query-log=1
      - --slow-query-log-file=/var/log/mysql/slow.log
      - --long-query-time=2
    networks:
      - msa-network
    restart: always
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ================================
  # Optional: Nginx Reverse Proxy
  # ================================
  nginx:
    image: nginx:alpine
    container_name: msa-nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - msa-network
    depends_on:
      - frontend
      - spring-api
      - python-ai
    restart: always
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    profiles:
      - with-nginx  # Only starts with: docker-compose --profile with-nginx up

# ================================
# Networks
# ================================
networks:
  msa-network:
    driver: bridge
    name: msa-prod-network
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ================================
# Volumes
# ================================
volumes:
  mysql-data-prod:
    driver: local
    name: msa-mysql-data-prod

# ================================
# PRODUCTION NOTES
# ================================
# 1. BEFORE DEPLOYING:
#    - Ensure .env file has production values
#    - Set strong passwords
#    - Configure SSL certificates
#    - Review resource limits
#
# 2. DEPLOY:
#    docker-compose -f docker-compose.prod.yml up -d
#
# 3. MONITORING:
#    docker-compose -f docker-compose.prod.yml ps
#    docker-compose -f docker-compose.prod.yml logs -f
#
# 4. BACKUP:
#    Use scripts/backup.sh for database backups
#
# 5. UPDATE:
#    docker-compose -f docker-compose.prod.yml pull
#    docker-compose -f docker-compose.prod.yml up -d --build
#
# 6. ROLLBACK:
#    docker-compose -f docker-compose.prod.yml down
#    # Restore from backup
#    docker-compose -f docker-compose.prod.yml up -d
#
# 7. SECURITY:
#    - MySQL port is NOT exposed externally
#    - Use Nginx reverse proxy for SSL termination
#    - Enable firewall rules
#    - Regularly update images
